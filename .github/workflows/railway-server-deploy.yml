name: Deploy Server to Railway

on:
  push:
    branches: [ main ]
    paths:
      - 'buzz-smile-saas/server/**'
      - 'buzz-smile-saas/railway.json'
      - 'buzz-smile-saas/.github/workflows/railway-server-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Railway CLI (direct deploy path)
        if: ${{ secrets.RAILWAY_TOKEN }}
        run: npm i -g @railway/cli

      - name: Login to Railway (direct deploy path)
        if: ${{ secrets.RAILWAY_TOKEN }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway login --token "$RAILWAY_TOKEN"

      - name: Verify Railway project link (direct deploy path)
        if: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: buzz-smile-saas/server
        run: railway status

      - name: Deploy server service (direct deploy path)
        if: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: buzz-smile-saas/server
        run: railway up --detach

      - name: Fallback: trigger Railway via GitHub integration (no-op commit)
        if: ${{ !secrets.RAILWAY_TOKEN }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          mkdir -p buzz-smile-saas/server
          echo "$(date) â€“ integration poke" >> buzz-smile-saas/server/deploy-poke.txt
          git add buzz-smile-saas/server/deploy-poke.txt
          git commit -m "chore: poke Railway integration [skip ci]"
          git fetch origin ${{ github.ref_name }}
          git pull --rebase origin ${{ github.ref_name }}
          git push origin HEAD:${{ github.ref_name }}

      - name: Outcome summary
        run: |
          echo "Direct deploy used: ${{ secrets.RAILWAY_TOKEN }}"
          echo "Fallback used: ${{ !secrets.RAILWAY_TOKEN }}"