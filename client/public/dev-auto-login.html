<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dev Auto Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 680px; margin: auto; }
    .log { background: #111; color: #0f0; padding: 12px; border-radius: 8px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .error { color: #d32f2f; }
    .ok { color: #2e7d32; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <h1>Dev Auto Login</h1>
  <p>This page will reset the password in development (if needed), log in, store the token to <code>localStorage</code>, and redirect you to the dashboard.</p>
  <p class="muted">You can override defaults with query params: <code>?email=...&password=...&api=...</code></p>
  <div class="log" id="log">Starting...</div>
  <script>
    (async () => {
      const logEl = document.getElementById('log');
      const log = (msg) => { logEl.textContent += "\n" + msg; };
      const params = new URLSearchParams(location.search);
      const email = params.get('email') || 'npkalyx@gmail.com';
      const password = params.get('password') || 'temppass123';
      const api = params.get('api') || 'http://localhost:5000';

      log(`API: ${api}`);
      log(`Email: ${email}`);

      // Try dev reset (non-production only)
      try {
        const resetRes = await fetch(`${api}/api/auth/dev/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword: password })
        });
        if (resetRes.ok) {
          const resetData = await resetRes.json();
          log(`Password reset: ${resetData.message || 'OK'}`);
        } else {
          const text = await resetRes.text();
          log(`Dev reset skipped (${resetRes.status}): ${text}`);
        }
      } catch (e) {
        log(`Dev reset error: ${e.message}`);
      }

      // Attempt login
      try {
        log('Logging in...');
        const loginRes = await fetch(`${api}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!loginRes.ok) {
          const errText = await loginRes.text();
          log(`Login failed (${loginRes.status}): ${errText}`);
          log('Check that the server is running and credentials exist in the active DB.');
          return;
        }

        const data = await loginRes.json();
        const token = data.token;
        if (!token) {
          log('No token returned.');
          return;
        }

        // Store token in current origin (http://localhost:3000)
        localStorage.setItem('token', token);
        log('Token stored in localStorage. Redirecting to /dashboard...');
        // Give React a moment to pick up token
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 300);
      } catch (e) {
        log(`Login error: ${e.message}`);
      }
    })();
  </script>
</body>
</html>