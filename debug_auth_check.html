<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1976d2; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Authentication Debug Tool</h1>
    
    <button onclick="checkAuth()">Check Authentication Status</button>
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testUpload()">Test Upload API</button>
    <button onclick="clearAuth()">Clear Authentication</button>
    
    <div id="result"></div>

    <script>
        const API_URL = 'http://localhost:5000';
        
        function displayResult(message, type = 'info') {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            let message = `<h3>Authentication Status</h3>`;
            
            if (token) {
                message += `<p><strong>Token found:</strong> ${token.substring(0, 50)}...</p>`;
                
                // Try to decode JWT payload
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    message += `<p><strong>Token payload:</strong></p><pre>${JSON.stringify(payload, null, 2)}</pre>`;
                    
                    const now = Date.now() / 1000;
                    if (payload.exp && payload.exp < now) {
                        message += `<p class="error">⚠️ Token is expired!</p>`;
                    } else {
                        message += `<p class="success">✅ Token is valid</p>`;
                    }
                } catch (e) {
                    message += `<p class="error">❌ Error decoding token: ${e.message}</p>`;
                }
            } else {
                message += `<p class="error">❌ No token found in localStorage</p>`;
            }
            
            displayResult(message, token ? 'success' : 'error');
        }

        async function testLogin() {
            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    displayResult(`<h3>Login Successful</h3><p>Token saved to localStorage</p><pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    displayResult(`<h3>Login Failed</h3><p>${data.message}</p>`, 'error');
                }
            } catch (error) {
                displayResult(`<h3>Login Error</h3><p>${error.message}</p>`, 'error');
            }
        }

        async function testUpload() {
            const token = localStorage.getItem('token');
            if (!token) {
                displayResult('No token found. Please login first.', 'error');
                return;
            }

            try {
                // Create a dummy file
                const blob = new Blob(['fake video content'], { type: 'video/mp4' });
                const file = new File([blob], 'test.mp4', { type: 'video/mp4' });
                
                const formData = new FormData();
                formData.append('video', file);
                formData.append('title', 'Test Upload');
                formData.append('description', 'Test upload from debug tool');

                const response = await fetch(`${API_URL}/api/videos/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayResult(`<h3>Upload Successful</h3><pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    displayResult(`<h3>Upload Failed</h3><p>Status: ${response.status}</p><p>Message: ${data.message}</p><pre>${JSON.stringify(data, null, 2)}</pre>`, 'error');
                }
            } catch (error) {
                displayResult(`<h3>Upload Error</h3><p>${error.message}</p>`, 'error');
            }
        }

        function clearAuth() {
            localStorage.removeItem('token');
            displayResult('Authentication cleared from localStorage', 'info');
        }

        // Auto-check auth on page load
        window.onload = checkAuth;
    </script>
</body>
</html>